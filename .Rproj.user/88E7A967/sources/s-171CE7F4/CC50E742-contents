---
title: "Homework 7: Database Querying"
subtitle: "SDS 192"
author: "Kathleen Hablutzel"
date: "`r format(Sys.Date(), '%B %e, %Y')`"
output: 
  html_document:
    toc: true
    toc_depth: 2
    toc_float: true
    fig_width: 7
    fig_height: 6
    fig_caption: true
    df_print: paged
    code_folding: hide
---

```{r setup, include=FALSE}
library(tidyverse)
library(sds192)
library(RMySQL)
db <- dbConnect(
  MySQL(), 
  host = "scidb.smith.edu", 
  user = "sds192", 
  password = "DSismfc@S", 
  dbname = "yelp"
)
knitr::opts_chunk$set(
  message = FALSE,
  echo = TRUE,
  connection = db,
  max.print = 20
)
```

## Top 20 Taco Restaurants

```{sql connection=db}
SELECT b.name, sum(1) num_reviews,
	count(r.user_id) num_reviewers_in_reviews_table,
	count(u.user_id) num_reviewers_in_users_table,
	avg(r.stars) mean_number_of_stars
FROM reviews r
JOIN businesses b ON b.id = r.business_id
LEFT JOIN users u ON u.user_id = r.user_id
WHERE b.name LIKE "%taco%"
GROUP BY b.id
HAVING num_reviews >= 25
ORDER BY mean_number_of_stars DESC
LIMIT 0, 20;
```

## Interactive Restaurant Map

```{r Mapping Packages}
# Mapping packages
library(sf)
library(leaflet)
```


```{sql connection=db, output.var="taco_places"}
-- Same code as before, but also selected lat and long columns
SELECT b.name, sum(1) num_reviews,
	count(r.user_id) num_reviewers_in_reviews_table,
	count(u.user_id) num_reviewers_in_users_table,
	avg(r.stars) mean_number_of_stars,
	b.longitude lon, b.latitude lat
FROM reviews r
JOIN businesses b ON b.id = r.business_id
LEFT JOIN users u ON u.user_id = r.user_id
WHERE b.name LIKE "%taco%"
GROUP BY b.id
HAVING num_reviews >= 25
ORDER BY mean_number_of_stars DESC
LIMIT 0, 20;
```

```{r To sf Object}
# Convert coordinates to points
sf_tacos <- taco_places %>%
  rename(stars = mean_number_of_stars) %>%
  select(name, stars, lon, lat) %>%
  st_as_sf(coords = c("lon", "lat"))
```

```{r Plot}
# Plot taco restaurants
leaflet(data = sf_tacos) %>%
  addTiles() %>%
  addMarkers(popup = paste0(sf_tacos %>%
                              pull(name),
                            "<br>",
                            sf_tacos %>%
                              pull(stars)))
```


## Word count

```{r word_count, message=FALSE, echo=FALSE}
sds192::text_stats()
```

